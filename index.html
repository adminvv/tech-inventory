<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Van Vleck ISD - Technology Inventory</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
</head>
<body class="bg-gray-50">
  <div id="app"></div>

  <script>
    // State management
    let state = {
      items: JSON.parse(localStorage.getItem('techInventory') || '[]'),
      sites: [],
      rooms: [],
      sheetsUrl: localStorage.getItem('sheetsUrl') || '',
      searchTerm: '',
      currentView: 'inventory',
      showAddModal: false,
      showScanner: false,
      showClassroomsOnly: true,
      editingItem: null,
      scannerActive: false,
      codeReader: null,
      videoStream: null,
      formData: {
        name: '',
        barcode: '',
        category: 'Desktop',
        site: '',
        room: '',
        status: 'Available',
        assignedTo: '',
        purchaseDate: ''
      }
    };

    const categories = ['Desktop', 'TV', 'Laptop', 'Tablet', 'Printer', 'Switch', 'Server', 'UPS', 'Other'];
    const statuses = ['Available', 'In Use', 'In Repair', 'Retired'];

    // Utility functions
    function isClassroom(roomNumber) {
      const room = roomNumber.includes(' - ') ? roomNumber.split(' - ')[1] : roomNumber;
      const excludeKeywords = [
        'RESTROOM', 'RR', 'STORAGE', 'CUSTODIAL', 'MECHANICAL', 'ELECTRICAL',
        'IDF', 'MDF', 'CORRIDOR', 'OFFICE', 'CLINIC', 'KITCHEN', 'VESTIBULE',
        'STAIR', 'ELEVATOR', 'FIRE RISER', 'BOILER', 'RECEPTION', 'ATTENDANCE',
        'WORKROOM', 'ISS', 'RECORDS', 'SERVICE YARD', 'ENTRY', 'MAIN STREET',
        'CIRCULATION', 'LOUNGE', 'CHAIR STORAGE', 'GYM STORAGE', 'LOCKERS'
      ];
      const roomUpper = room.toUpperCase();
      return !excludeKeywords.some(keyword => roomUpper.includes(keyword));
    }

    function getFilteredRooms() {
      if (!state.formData.site) return [];
      let filteredRooms = state.rooms.filter(room => room.startsWith(state.formData.site + ' - '));
      if (state.showClassroomsOnly) {
        filteredRooms = filteredRooms.filter(room => isClassroom(room));
      }
      return filteredRooms.map(room => room.replace(state.formData.site + ' - ', ''));
    }

    function formatDateTime(isoString) {
      if (!isoString) return 'N/A';
      const date = new Date(isoString);
      return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
    }

    function showMessage(message, type = 'success') {
      const msgDiv = document.createElement('div');
      msgDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-100 text-green-800' :
        type === 'error' ? 'bg-red-100 text-red-800' :
        'bg-blue-100 text-blue-800'
      }`;
      msgDiv.textContent = message;
      document.body.appendChild(msgDiv);
      setTimeout(() => msgDiv.remove(), 3000);
    }

    // Camera scanner functions
    async function startCameraScanner() {
      state.showScanner = true;
      state.scannerActive = false;
      render();
      
      // Wait for DOM to be ready
      setTimeout(async () => {
        try {
          const codeReader = new ZXing.BrowserMultiFormatReader();
          state.codeReader = codeReader;
          
          // Get video devices
          const videoInputDevices = await codeReader.listVideoInputDevices();
          
          if (videoInputDevices.length === 0) {
            showMessage('No camera found on this device', 'error');
            return;
          }
          
          // Use back camera if available (for phones)
          let selectedDeviceId = videoInputDevices[0].deviceId;
          for (const device of videoInputDevices) {
            if (device.label.toLowerCase().includes('back') || device.label.toLowerCase().includes('rear')) {
              selectedDeviceId = device.deviceId;
              break;
            }
          }
          
          // Start decoding from video device
          state.scannerActive = true;
          codeReader.decodeFromVideoDevice(selectedDeviceId, 'video-preview', (result, err) => {
            if (result) {
              // Barcode scanned successfully!
              const barcode = result.text;
              stopCameraScanner();
              state.formData.barcode = barcode;
              state.showScanner = false;
              state.showAddModal = true;
              render();
              showMessage('Barcode scanned: ' + barcode);
            }
            // Ignore errors - they happen while scanning
          });
          
        } catch (err) {
          console.error('Camera error:', err);
          showMessage('Camera access denied or not available', 'error');
          state.scannerActive = false;
        }
      }, 200);
    }

    function stopCameraScanner() {
      if (state.codeReader && state.scannerActive) {
        state.codeReader.reset();
        state.scannerActive = false;
        state.codeReader = null;
      }
    }

    function closeScannerModal() {
      stopCameraScanner();
      state.showScanner = false;
      render();
    }

    // API functions
    async function syncToSheets() {
      if (!state.sheetsUrl) {
        showMessage('Please configure Google Sheets URL in Settings first', 'error');
        return;
      }

      try {
        await fetch(state.sheetsUrl, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'sync',
            items: state.items,
            sites: state.sites,
            rooms: state.rooms
          })
        });
        showMessage('Auto-synced to Google Sheets successfully!');
      } catch (error) {
        console.error('Sync error:', error);
        showMessage('Auto-sync failed. Will retry on next change.', 'error');
      }
    }

    async function loadFromSheets() {
      if (!state.sheetsUrl) {
        alert('Please configure Google Sheets URL in Settings first');
        return;
      }

      try {
        const response = await fetch(`${state.sheetsUrl}?action=load&timestamp=${Date.now()}`);
        const data = await response.json();
        
        if (data.items) state.items = data.items;
        if (data.sites) state.sites = data.sites;
        if (data.rooms) state.rooms = data.rooms;
        
        localStorage.setItem('techInventory', JSON.stringify(state.items));
        showMessage('Data loaded from Google Sheets successfully!');
        render();
      } catch (error) {
        console.error('Load error:', error);
        showMessage('Error loading from Google Sheets. Using local data.', 'error');
      }
    }

    // Item operations
    function addItem() {
      if (!state.formData.name || !state.formData.barcode) {
        alert('Please fill in name and barcode');
        return;
      }

      const now = new Date().toISOString();
      const location = `${state.formData.site} - ${state.formData.room}`;
      
      const newItem = {
        id: Date.now(),
        ...state.formData,
        location: location,
        dateAdded: now,
        lastModified: now
      };

      state.items.push(newItem);
      localStorage.setItem('techInventory', JSON.stringify(state.items));
      resetForm();
      state.showAddModal = false;
      syncToSheets();
      render();
    }

    function editItem() {
      if (!state.formData.name || !state.formData.barcode) {
        alert('Please fill in name and barcode');
        return;
      }

      const now = new Date().toISOString();
      const location = `${state.formData.site} - ${state.formData.room}`;
      
      state.items = state.items.map(item => 
        item.id === state.editingItem.id ? {
          ...item,
          ...state.formData,
          location: location,
          lastModified: now,
          dateAdded: item.dateAdded
        } : item
      );

      localStorage.setItem('techInventory', JSON.stringify(state.items));
      resetForm();
      state.editingItem = null;
      state.showAddModal = false;
      syncToSheets();
      render();
    }

    function deleteItem(id) {
      if (confirm('Are you sure you want to delete this item?')) {
        state.items = state.items.filter(item => item.id !== id);
        localStorage.setItem('techInventory', JSON.stringify(state.items));
        syncToSheets();
        render();
      }
    }

    function openEditModal(item) {
      const locationParts = item.location ? item.location.split(' - ') : ['', ''];
      const site = locationParts[0] || '';
      const room = locationParts.slice(1).join(' - ') || '';
      
      state.editingItem = item;
      state.formData = {
        name: item.name,
        barcode: item.barcode,
        category: item.category,
        site: site,
        room: room,
        status: item.status,
        assignedTo: item.assignedTo || '',
        purchaseDate: item.purchaseDate || ''
      };
      state.showAddModal = true;
      render();
    }

    function resetForm() {
      state.formData = {
        name: '',
        barcode: '',
        category: 'Desktop',
        site: '',
        room: '',
        status: 'Available',
        assignedTo: '',
        purchaseDate: ''
      };
    }

    function saveSettings() {
      localStorage.setItem('sheetsUrl', state.sheetsUrl);
      showMessage('Settings saved successfully!');
    }

    // Render functions
    function render() {
      const app = document.getElementById('app');
      const filteredItems = state.items.filter(item =>
        item.name.toLowerCase().includes(state.searchTerm.toLowerCase()) ||
        item.barcode.toLowerCase().includes(state.searchTerm.toLowerCase()) ||
        item.location.toLowerCase().includes(state.searchTerm.toLowerCase())
      );

      app.innerHTML = `
        <div class="max-w-7xl mx-auto p-4">
          <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <!-- Header -->
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
              <div class="flex items-center gap-3">
                <svg class="text-blue-600" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="3" y1="9" x2="21" y2="9"></line>
                  <line x1="9" y1="21" x2="9" y2="9"></line>
                </svg>
                <h1 class="text-3xl font-bold text-gray-800">Technology Inventory</h1>
              </div>
              
              <div class="flex gap-2">
                <button onclick="changeView('inventory')" 
                  class="px-4 py-2 rounded-lg ${state.currentView === 'inventory' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}">
                  Inventory
                </button>
                <button onclick="loadFromSheets()" 
                  class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                  Load from Sheets
                </button>
                <button onclick="changeView('settings')" 
                  class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                  Settings
                </button>
              </div>
            </div>

            ${state.currentView === 'inventory' ? renderInventoryView(filteredItems) : renderSettingsView()}
          </div>
        </div>

        ${state.showScanner ? renderScannerModal() : ''}
        ${state.showAddModal ? renderAddModal() : ''}
      `;
    }

    function renderInventoryView(filteredItems) {
      return `
        <!-- Search and Actions -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
          <div class="flex-1 relative">
            <input type="text" 
              placeholder="Search by name, barcode, or location..." 
              value="${state.searchTerm}"
              oninput="state.searchTerm = this.value; render();"
              class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          <button onclick="startCameraScanner()" 
            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
            Scan Barcode
          </button>
          <button onclick="resetForm(); state.editingItem = null; state.showAddModal = true; render();" 
            class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
            Add Item
          </button>
        </div>

        <!-- Inventory Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Barcode</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Location</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Assigned To</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date Added</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Modified</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${filteredItems.map(item => `
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-4 text-sm font-medium text-gray-900">${item.name}</td>
                  <td class="px-4 py-4 text-sm text-gray-900">${item.barcode}</td>
                  <td class="px-4 py-4 text-sm text-gray-900">${item.category}</td>
                  <td class="px-4 py-4 text-sm text-gray-900">${item.location}</td>
                  <td class="px-4 py-4">
                    <span class="px-2 text-xs font-semibold rounded-full ${
                      item.status === 'Available' ? 'bg-green-100 text-green-800' :
                      item.status === 'In Use' ? 'bg-blue-100 text-blue-800' :
                      item.status === 'In Repair' ? 'bg-yellow-100 text-yellow-800' :
                      'bg-gray-100 text-gray-800'
                    }">
                      ${item.status}
                    </span>
                  </td>
                  <td class="px-4 py-4 text-sm text-gray-900">${item.assignedTo || '-'}</td>
                  <td class="px-4 py-4 text-sm text-gray-500">${formatDateTime(item.dateAdded)}</td>
                  <td class="px-4 py-4 text-sm text-gray-500">${formatDateTime(item.lastModified)}</td>
                  <td class="px-4 py-4 text-sm">
                    <button onclick='openEditModal(${JSON.stringify(item).replace(/'/g, "&apos;")})' 
                      class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                    <button onclick="deleteItem(${item.id})" 
                      class="text-red-600 hover:text-red-900">Delete</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        ${filteredItems.length === 0 ? '<div class="text-center py-12 text-gray-500 text-lg">No items found</div>' : ''}
      `;
    }

    function renderSettingsView() {
      return `
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Settings</h2>
        
        <div class="mb-8">
          <h3 class="text-lg font-semibold text-gray-700 mb-3">Google Sheets Integration</h3>
          <p class="text-sm text-gray-600 mb-3">Enter your Google Apps Script Web App URL to sync data with Google Sheets.</p>
          <input type="text" 
            value="${state.sheetsUrl}"
            oninput="state.sheetsUrl = this.value"
            placeholder="https://script.google.com/macros/s/..."
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-3">
          <button onclick="saveSettings()" 
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
            Save Settings
          </button>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h3 class="text-lg font-semibold text-gray-700 mb-2">📋 Managing Sites & Rooms</h3>
          <p class="text-sm text-gray-700 mb-2"><strong>Sites and Rooms are managed in Google Sheets!</strong></p>
          <ol class="text-sm text-gray-600 list-decimal list-inside space-y-1 ml-2">
            <li>Open your Google Sheet (the one connected to this app)</li>
            <li>Go to the "Sites" tab to manage school sites</li>
            <li>Go to the "Rooms" tab to manage room numbers</li>
            <li>Add or delete rows as needed</li>
            <li>Come back here and click "Load from Sheets" button</li>
          </ol>
        </div>
      `;
    }

    function renderScannerModal() {
      return `
        <div class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
          <div class="bg-white p-6 rounded-lg max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold">Scan Barcode</h3>
              <button onclick="closeScannerModal()" class="text-gray-500 hover:text-gray-700 text-2xl">✕</button>
            </div>
            
            <!-- Camera Preview -->
            <div class="relative mb-4">
              <video id="video-preview" class="w-full rounded-lg border-2 border-blue-500" style="max-height: 400px;"></video>
              <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 border-2 border-green-500 w-64 h-32 pointer-events-none"></div>
            </div>
            
            <p class="text-sm text-gray-600 text-center mb-4">
              Point camera at barcode or Dell service tag
            </p>
            
            <div class="border-t pt-4 mt-4">
              <p class="text-sm text-gray-600 mb-3 text-center">Or enter manually:</p>
              <input type="text" id="manualBarcodeInput" 
                placeholder="Type barcode here" 
                class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-3 text-center text-lg">
              <button onclick="
                const barcode = document.getElementById('manualBarcodeInput').value;
                if (barcode) {
                  stopCameraScanner();
                  state.formData.barcode = barcode;
                  state.showScanner = false;
                  state.showAddModal = true;
                  render();
                  showMessage('Barcode entered successfully!');
                } else {
                  alert('Please enter a barcode');
                }
              " class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                Use Manual Entry
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderAddModal() {
      const filteredRooms = getFilteredRooms();
      
      return `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div class="bg-white p-6 rounded-lg max-w-2xl w-full m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold">${state.editingItem ? 'Edit Item' : 'Add New Item'}</h3>
              <button onclick="state.showAddModal = false; state.editingItem = null; resetForm(); render();" 
                class="text-gray-500 hover:text-gray-700">✕</button>
            </div>

            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
                <input type="text" value="${state.formData.name}" 
                  oninput="state.formData.name = this.value"
                  placeholder="e.g., Dell Latitude 5420"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Barcode</label>
                <input type="text" value="${state.formData.barcode}" 
                  oninput="state.formData.barcode = this.value"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                <select onchange="state.formData.category = this.value" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  ${categories.map(cat => 
                    `<option value="${cat}" ${state.formData.category === cat ? 'selected' : ''}>${cat}</option>`
                  ).join('')}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Site</label>
                <select onchange="state.formData.site = this.value; state.formData.room = ''; render();" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  <option value="">Select Site</option>
                  ${state.sites.map(site => 
                    `<option value="${site}" ${state.formData.site === site ? 'selected' : ''}>${site}</option>`
                  ).join('')}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Room</label>
                <div class="flex items-center gap-2 mb-2 bg-blue-50 p-2 rounded">
                  <input type="checkbox" id="classroomFilter" 
                    ${state.showClassroomsOnly ? 'checked' : ''}
                    onchange="state.showClassroomsOnly = this.checked; render();">
                  <label for="classroomFilter" class="text-sm text-gray-700">
                    Show classrooms only (hide storage, mechanical, restrooms, etc.)
                  </label>
                </div>
                <select onchange="state.formData.room = this.value" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg" 
                  ${!state.formData.site ? 'disabled' : ''}>
                  <option value="">${state.formData.site ? 'Select Room' : 'Select Site First'}</option>
                  ${filteredRooms.map(room => 
                    `<option value="${room}" ${state.formData.room === room ? 'selected' : ''}>${room}</option>`
                  ).join('')}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select onchange="state.formData.status = this.value" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  ${statuses.map(status => 
                    `<option value="${status}" ${state.formData.status === status ? 'selected' : ''}>${status}</option>`
                  ).join('')}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Assigned To (Optional)</label>
                <input type="text" value="${state.formData.assignedTo}" 
                  oninput="state.formData.assignedTo = this.value"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Purchase Date (Optional)</label>
                <input type="date" value="${state.formData.purchaseDate}" 
                  oninput="state.formData.purchaseDate = this.value"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              </div>

              <div class="flex gap-3">
                <button onclick="state.showAddModal = false; state.editingItem = null; resetForm(); render();" 
                  class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">
                  Cancel
                </button>
                <button onclick="${state.editingItem ? 'editItem()' : 'addItem()'}" 
                  class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                  ${state.editingItem ? 'Save Changes' : 'Add Item'}
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function changeView(view) {
      state.currentView = view;
      render();
    }

    // Load saved URL and data on startup
    if (state.sheetsUrl) {
      loadFromSheets();
    }

    // Initial render
    render();
  </script>
</body>
</html>